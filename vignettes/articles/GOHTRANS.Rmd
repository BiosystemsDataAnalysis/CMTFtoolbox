---
title: "GOHTRANS"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dplyr)
library(tidyr)
library(ggplot2)
library(parafac4microbiome)
library(NPLStoolbox)
library(CMTFtoolbox)
library(scales)
```

# ACMTF
```{r acmtf homogenize and process data}
homogenizedSamples1 = intersect(NPLStoolbox::Cornejo2025$Tongue_microbiome$mode1 %>% filter(!is.na(GenderID)) %>% select(subject) %>% pull(), NPLStoolbox::Cornejo2025$Salivary_microbiome$mode1 %>% filter(!is.na(GenderID)) %>% select(subject) %>% pull())
homogenizedSamples2 = intersect(NPLStoolbox::Cornejo2025$Salivary_cytokines$mode1 %>% filter(!is.na(GenderID)) %>% select(subject) %>% pull(), NPLStoolbox::Cornejo2025$Salivary_biochemistry$mode1 %>% filter(!is.na(GenderID)) %>% select(subject) %>% pull())
homogenizedSamples3 = NPLStoolbox::Cornejo2025$Circulatory_hormones$mode1 %>% filter(!is.na(GenderID)) %>% select(subject) %>% pull()

homogenizedSamples = intersect(intersect(homogenizedSamples1, homogenizedSamples2), homogenizedSamples3)

# Tongue
newTongue = NPLStoolbox::Cornejo2025$Tongue

mask = newTongue$mode1$subject %in% homogenizedSamples
newTongue$data = newTongue$data[mask,,]
newTongue$mode1 = newTongue$mode1[mask,]

processedTongue = processDataCube(newTongue, sparsityThreshold = 0.5, considerGroups=TRUE, groupVariable="GenderID", CLR=TRUE, centerMode=1, scaleMode=2)

# Saliva
newSaliva = NPLStoolbox::Cornejo2025$Salivary_microbiome

mask = newSaliva$mode1$subject %in% homogenizedSamples
newSaliva$data = newSaliva$data[mask,,]
newSaliva$mode1 = newSaliva$mode1[mask,]

processedSaliva = processDataCube(newSaliva, sparsityThreshold = 0.5, considerGroups=TRUE, groupVariable="GenderID", CLR=TRUE, centerMode=1, scaleMode=2)

# Cytokines
newCytokines = NPLStoolbox::Cornejo2025$Salivary_cytokines

mask = newCytokines$mode1$subject %in% homogenizedSamples
newCytokines$data = log(newCytokines$data[mask,,] + 0.1300)
newCytokines$mode1 = newCytokines$mode1[mask,]

processedCytokines = processDataCube(newCytokines, CLR=FALSE, centerMode=1, scaleMode=2)

# Biochemistry
newBio = NPLStoolbox::Cornejo2025$Salivary_biochemistry

mask = newBio$mode1$subject %in% homogenizedSamples
newBio$data = log(newBio$data[mask,,])
newBio$mode1 = newBio$mode1[mask,]

processedBiochemistry = processDataCube(newBio, CLR=FALSE, centerMode=1, scaleMode=2)

# Hormones
newHormones = NPLStoolbox::Cornejo2025$Circulatory_hormones

mask = newHormones$mode1$subject %in% homogenizedSamples
newHormones$data = log(newHormones$data[mask,,])
newHormones$mode1 = newHormones$mode1[mask,]

processedHormones = processDataCube(newHormones, CLR=FALSE, centerMode=1, scaleMode=2)

# Prep data
datasets = list(processedTongue$data, processedSaliva$data, processedCytokines$data, processedBiochemistry$data, processedHormones$data)
modes = list(c(1,2,3),c(1,4,5),c(1,6,7),c(1,8,9),c(1,10,11))
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
```

```{r acmtf model selection}
# Too computationally intensive
```

```{r fit acmtf}
acmtf_model = CMTFtoolbox::acmtf_opt(Z, 1, nstart = 10, method="L-BFGS", numCores=10)
```

```{r acmtf test the model}
testMetadata = function(model, comp, metadata){
  staticMeta = Cornejo2025$Subject_metadata
  
  dynamicMeta = rTensor::k_unfold(rTensor::as.tensor(Cornejo2025$Clinical_measurements$data), 2)@data %>% t() %>% as_tibble()
  colnames(dynamicMeta) = Cornejo2025$Clinical_measurements$mode2$V1
  dynamicMeta = dynamicMeta %>%
    mutate(subject = rep(as.numeric(Cornejo2025$Clinical_measurements$mode1$subject), each=nrow(Cornejo2025$Clinical_measurements$mode3))) %>%
    mutate(newTimepoint = rep(Cornejo2025$Clinical_measurements$mode3$newTimepoint, nrow(Cornejo2025$Clinical_measurements$mode1)))
  
  transformedSubjectLoadings_static = transformPARAFACloadings(model$Fac, 1)[,comp]
  transformedSubjectLoadings_dynamic = transformPARAFACloadings(model$Fac, 2, moreOutput=TRUE)$F[,comp]
  
  metadata_static = metadata$mode1 %>% mutate(subject = as.integer(subject)) %>% left_join(staticMeta) %>% mutate(GenderID = as.numeric(as.factor(GenderID)) - 1)
  metadata_dynamic = transformedSubjectLoadings_dynamic %>% as_tibble() %>% mutate(subject = rep(as.numeric(metadata$mode1$subject), each=nrow(metadata$mode3))) %>% mutate(newTimepoint = rep(metadata$mode3$newTimepoint, nrow(metadata$mode1))) %>% left_join(dynamicMeta)
  
  staticResult = lm(transformedSubjectLoadings_static ~ GenderID + Age, data = metadata_static)
  dynamicResult = lm(transformedSubjectLoadings_dynamic ~ BOP + CODS + XI, data = metadata_dynamic)

  # Extract coefficients and confidence intervals
  coef_estimates <- summary(staticResult)$coefficients
  conf_intervals <- confint(staticResult)
  
  # Remove intercept
  coef_estimates <- coef_estimates[rownames(coef_estimates) != "(Intercept)", ]
  conf_intervals <- conf_intervals[rownames(conf_intervals) != "(Intercept)", ]
  
  # Combine into a clean data frame
  summary_table <- data.frame(
    Term     = rownames(coef_estimates),
    Estimate = round(coef_estimates[, "Estimate"], 2),
    CI       = paste0(
                 round(conf_intervals[, 1], 2), " – ",
                 round(conf_intervals[, 2], 2)
               ),
    P_value  = signif(coef_estimates[, "Pr(>|t|)"], 3),
    row.names = NULL
  )
  
  # Extract coefficients and confidence intervals
  coef_estimates <- summary(dynamicResult)$coefficients
  conf_intervals <- confint(dynamicResult)
  
  # Remove intercept
  coef_estimates <- coef_estimates[rownames(coef_estimates) != "(Intercept)", ]
  conf_intervals <- conf_intervals[rownames(conf_intervals) != "(Intercept)", ]
  
  # Combine into a clean data frame
  summary_table2 <- data.frame(
    Term     = rownames(coef_estimates),
    Estimate = round(coef_estimates[, "Estimate"], 2),
    CI       = paste0(
                 round(conf_intervals[, 1], 2), " – ",
                 round(conf_intervals[, 2], 2)
               ),
    P_value  = signif(coef_estimates[, "Pr(>|t|)"], 3),
    row.names = NULL
  )
  
  result = rbind(summary_table, summary_table2)
  return(result)
}

testMetadata(acmtf_model, 1, processedTongue)
```

```{r acmtf plot the lambda matrix}
lambda = abs(acmtf_model$Fac[[12]])
colnames(lambda) = paste0("C", 1:1)

lambda %>%
  as_tibble() %>%
  mutate(block=c("tongue", "saliva", "cytokines", "biochemistry", "hormones")) %>%
  mutate(block=factor(block, levels=c("tongue", "saliva", "cytokines", "biochemistry", "hormones"))) %>%
  pivot_longer(-block) %>%
  ggplot(aes(x=as.factor(name),y=value,fill=as.factor(block))) +
  geom_bar(stat="identity",position=position_dodge(),col="black") +
  xlab("ACMTF component number") +
  ylab(expression(lambda)) +
  scale_x_discrete(labels=1:3) +
  scale_fill_manual(name="Dataset",values = hue_pal()(5),labels=c("Tongue microbiome", "Salivary microbiome", "Salivary cytokines", "Salivary biochemistry", "Circulatory hormones")) +
  theme(legend.position="top")
```

# ACMTF-R

```{r acmtfr prepare y}
Y = as.numeric(as.factor(processedTongue$mode1$GenderID))
Ycnt = Y - mean(Y)
Ynorm = Ycnt / norm(Ycnt, "2")
```

```{r acmtfr model selection}
# Too computationally intensive.
```

```{r acmtfr fit models}
acmtfr_model90 = CMTFtoolbox::acmtfr_opt(Z, Ynorm, 1, pi=0.90, nstart = 10, method="L-BFGS", numCores=10)
```

```{r acmtfr plot the lambda matrix}
lambda = abs(acmtfr_model90$Fac[[12]])
colnames(lambda) = paste0("C", 1:1)

lambda %>%
  as_tibble() %>%
  mutate(block=c("tongue", "saliva", "cytokines", "biochemistry", "hormones")) %>%
  mutate(block=factor(block, levels=c("tongue", "saliva", "cytokines", "biochemistry", "hormones"))) %>%
  pivot_longer(-block) %>%
  ggplot(aes(x=as.factor(name),y=value,fill=as.factor(block))) +
  geom_bar(stat="identity",position=position_dodge(),col="black") +
  xlab("ACMTF-R component number") +
  ylab(expression(lambda)) +
  scale_x_discrete(labels=1:3) +
  scale_fill_manual(name="Dataset",values = hue_pal()(5),labels=c("Tongue microbiome", "Salivary microbiome", "Salivary cytokines", "Salivary biochemistry", "Circulatory hormones")) +
  theme(legend.position="top")
```

```{r acmtfr test the model}
testMetadata(acmtfr_model90, 1, processedTongue)
```
